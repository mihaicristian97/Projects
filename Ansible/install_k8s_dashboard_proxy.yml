---
- name: Install Kubernetes Dashboard with persistent kubectl proxy
  hosts: master
  become: false
  
  vars:
    dashboard_url: "http://127.0.0.1:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/"
    kubectl_path: /usr/bin/kubectl
  
  tasks:
    - name: Install Kubernetes Dashboard
      command: >
        kubectl apply --kubeconfig /etc/kubernetes/admin.conf
        -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml

    - name: Wait for dashboard deployment to be available
      command: >
        kubectl -n kubernetes-dashboard
        rollout status deployment/kubernetes-dashboard
      environment:
        KUBECONFIG: /home/{{ ansible_user }}/.kube/config
      retries: 10
      delay: 15
      register: rollout
      until: rollout.rc == 0

    - name: Install metrics-server
      command: >
        kubectl apply --kubeconfig /etc/kubernetes/admin.conf
        -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
      environment:
        KUBECONFIG: /home/{{ ansible_user }}/.kube/config

    - name: Get current metrics-server deployment
      command: kubectl -n kube-system get deployment metrics-server -o yaml
      environment:
        KUBECONFIG: /home/{{ ansible_user }}/.kube/config
      register: metrics_yaml

    - name: Update metrics-server args robustly
      copy:
        dest: /tmp/metrics-server.yaml
        content: |
          {{ metrics_yaml.stdout
            | from_yaml
            | combine({
                'spec': {
                  'template': {
                    'spec': {
                      'containers': [
                        {
                          'name': 'metrics-server',
                          'image': (metrics_yaml.stdout | from_yaml).spec.template.spec.containers[0].image,
                          'args': [
                            '--cert-dir=/tmp',
                            '--secure-port=4443',
                            '--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname',
                            '--kubelet-use-node-status-port',
                            '--metric-resolution=15s',
                            '--kubelet-insecure-tls'
                          ]
                        }
                      ]
                    }
                  }
                }
              }, recursive=True)
            | to_nice_yaml
          }}

    - name: Apply updated metrics-server deployment
      command: kubectl apply -f /tmp/metrics-server.yaml
      environment:
        KUBECONFIG: /home/{{ ansible_user }}/.kube/config

    - name: Restart metrics-server
      command: kubectl -n kube-system rollout restart deployment metrics-server
      environment:
        KUBECONFIG: /home/{{ ansible_user }}/.kube/config

    - name: Wait for metrics-server to be ready
      command: kubectl -n kube-system rollout status deployment metrics-server
      environment:
        KUBECONFIG: /home/{{ ansible_user }}/.kube/config
      retries: 10
      delay: 15
      register: metrics_status
      until: metrics_status.rc == 0

    - name: Get current kube-flannel daemonset
      command: kubectl -n kube-flannel get daemonset kube-flannel-ds -o yaml
      environment:
        KUBECONFIG: /home/{{ ansible_user }}/.kube/config
      register: flannel_yaml

    - name: Update kube-flannel iface robustly
      copy:
        dest: /tmp/kube-flannel.yaml
        content: |
          {{ flannel_yaml.stdout
            | from_yaml
            | combine({
                'spec': {
                  'template': {
                    'spec': {
                      'containers': [
                        {
                          'name': 'kube-flannel',
                          'image': (flannel_yaml.stdout | from_yaml).spec.template.spec.containers[0].image,
                          'args': [
                            '--ip-masq',
                            '--kube-subnet-mgr',
                            '--iface=enp0s3'
                          ]
                        }
                      ]
                    }
                  }
                }
              }, recursive=True)
            | to_nice_yaml
          }}

    - name: Apply updated kube-flannel daemonset
      command: kubectl apply -f /tmp/kube-flannel.yaml
      environment:
        KUBECONFIG: /home/{{ ansible_user }}/.kube/config

    - name: Restart kube-flannel
      command: kubectl -n kube-flannel rollout restart daemonset kube-flannel-ds
      environment:
        KUBECONFIG: /home/{{ ansible_user }}/.kube/config

    - name: Create admin service account
      command: >
        kubectl create serviceaccount admin-user -n kubernetes-dashboard
      environment:
        KUBECONFIG: /home/{{ ansible_user }}/.kube/config
      failed_when: false

    - name: Create cluster role binding for admin user
      command: >
        kubectl create clusterrolebinding admin-user-binding
        --clusterrole=cluster-admin
        --serviceaccount=kubernetes-dashboard:admin-user
      environment:
        KUBECONFIG: /home/{{ ansible_user }}/.kube/config
      failed_when: false

    - name: Get dashboard login token
      command: >
        kubectl -n kubernetes-dashboard create token admin-user
      environment:
        KUBECONFIG: /home/{{ ansible_user }}/.kube/config
      register: token

    - name: Print dashboard token
      debug:
        msg: "Kubernetes Dashboard Token: {{ token.stdout }}"

    - name: Create systemd service for kubectl proxy
      copy:
        dest: /etc/systemd/system/kubectl-proxy.service
        mode: '0644'
        content: |
          [Unit]
          Description=Kubernetes Dashboard proxy
          After=network.target

          [Service]
          Environment=KUBECONFIG=/home/{{ ansible_user }}/.kube/config
          ExecStart={{ kubectl_path }} proxy --address=0.0.0.0 --accept-hosts='.*'
          Restart=always
          RestartSec=5
          User = root

          [Install]
          WantedBy=multi-user.target

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: yes

    - name: Enable and start kubectl proxy service
      ansible.builtin.systemd:
        name: kubectl-proxy.service
        state: started
        enabled: yes

    - name: Print dashboard access URL
      debug:
        msg: "Access the Kubernetes Dashboard at: {{ dashboard_url }}" 